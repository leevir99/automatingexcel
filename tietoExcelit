Sub tietoExcelit()
    ' Check if B40 is empty
    If Range("B40").Value = "" Then
        MsgBox "Tietoja ei onnistuttu tuomaan. Tarkista hankenumero solusta B40."
        Exit Sub
    End If
    
    ' Define the folder and file path
    Dim folderAddress As String
    folderAddress = "Z:\Lähetysohjeet\Asiakirjojen tietoexcelit\" & Range("B40").Value & ".xlsx"
    
    ' Check if the info excel exists
    If Dir(folderAddress) = "" Then
        MsgBox "Tietoja ei onnistuttu tuomaan. Tarkista hankenumero solusta B40."
        Exit Sub
    End If
    
    ' Open the info excel in the background
    Dim infoWorkbook As Workbook
    Set infoWorkbook = Workbooks.Open(folderAddress)
    
    ' Retrieve the bank name from "Yleinen" tab
    Dim bankName As String
    bankName = infoWorkbook.Sheets("Yleinen").Range("H1").Value
    
    ' Copy the bank name to the desired locations in "Main" sheet
    ThisWorkbook.Sheets("Main").Range("D18").Value = bankName
    ThisWorkbook.Sheets("Main").Range("B146:C146").Value = bankName
    
    ' Find the range of loan numbers
    Dim lastRow As Long
    On Error Resume Next
    lastRow = infoWorkbook.Sheets("Yleinen").Range("A:A").Find("LISÄTIEDOT").Row - 1
    On Error GoTo 0
    
    If lastRow < 1 Then
        MsgBox "Enemmän kuin neljä lainaa löydetty. Tarkista tuodut tiedot lainoista."
        infoWorkbook.Close False
        Exit Sub
    End If
    
    Dim bankID As String
    On Error Resume Next
    bankID = infoWorkbook.Sheets("Yleinen").Range("A:A").Find("Konttorin numero").Offset(0, 1).Value
    On Error GoTo 0
    
    If bankID = "" Then
        MsgBox "Konttorin numero ei löydy. Tarkista tuodut tiedot lainoista."
        infoWorkbook.Close False
        Exit Sub
    End If
    
    Dim loanNumbersRange As Range
    Set loanNumbersRange = infoWorkbook.Sheets("Yleinen").Range("B1:B" & lastRow)
    
    Dim loanNumber As Range
    Dim loanNumbers As Range
    Set loanNumbers = ThisWorkbook.Sheets("Main").Range("B53:B56")
    
    Dim loanAmounts As Range
    Set loanAmounts = ThisWorkbook.Sheets("Main").Range("C53:C56")
    
    Dim count As Integer
    count = 1
    
    For Each loanNumber In loanNumbersRange
        If Left(loanNumber.Value, Len(bankID)) = bankID Then
            loanNumbers.Cells(count, 1).Value = loanNumber.Value
            loanAmounts.Cells(count, 1).Value = infoWorkbook.Sheets("Yleinen").Cells(loanNumber.Row, "D").Value
            count = count + 1
            If count > 4 Then
                MsgBox "Enemmän kuin neljä lainaa löydetty. Tarkista tuodut tiedot lainoista."
                infoWorkbook.Close False
                Exit Sub
            End If
        End If
    Next loanNumber
    
    ' Find and retrieve "Vak_arvon vahvistaja" from column A
    Dim vakArvonVahvistaja As Range
    Set vakArvonVahvistaja = infoWorkbook.Sheets("Yleinen").Range("A:A").Find("Vak_arvon vahvistaja", LookAt:=xlWhole)
    
    If Not vakArvonVahvistaja Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A120").Value = vakArvonVahvistaja.Offset(0, 1).Value
    End If
    
    ' Find and retrieve "Päättäjät" from column A
    Dim paattajat As Range
    Set paattajat = infoWorkbook.Sheets("Yleinen").Range("A:A").Find("Päättäjät", LookAt:=xlWhole)
    
    If Not paattajat Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A121").Value = paattajat.Offset(0, 1).Value
    End If
    
    ' Find and retrieve "Päätös pvm" from column A
    Dim paatosPvm As Range
    Set paatosPvm = infoWorkbook.Sheets("Yleinen").Range("A:A").Find("Päätös pvm", LookAt:=xlWhole)
    
    If Not paatosPvm Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A122").Value = paatosPvm.Offset(0, 1).Value
    End If
    
    ' Close the info excel
    infoWorkbook.Close False
    
    ' Display success message
    MsgBox "Tiedot tuotu onnistuneesti."
End Sub
