Sub tietoExcelit()
    ' Tarkistetaan, onko B40 tyhjä
    If Range("B40").Value = "" Then
        MsgBox "Tietoja ei onnistuttu tuomaan. Tarkista hankenumero solusta B40."
        Exit Sub
    End If
    
    ' Määritellään kansio ja tiedostopolku
    Dim kansioPolku As String
    kansioPolku = "Z:\Lähetysohjeet\Asiakirjojen tietoexcelit\" & Range("B40").Value & ".xlsx"
    
    ' Tarkistetaan, onko tiedostoa olemassa
    If Dir(kansioPolku) = "" Then
        MsgBox "Tietoja ei onnistuttu tuomaan. Tarkista hankenumero solusta B40."
        Exit Sub
    End If
    
    ' Avataan tietoexcel taustalla
    Dim infoTiedosto As Workbook
    Set infoTiedosto = Workbooks.Open(kansioPolku)
    
    ' Haetaan pankin nimi välilehdeltä "Yleinen"
    Dim pankinNimi As String
    pankinNimi = infoTiedosto.Sheets("Yleinen").Range("H1").Value
    
    ' Kopioidaan pankin nimi haluttuihin kohtiin "Main"-välilehdellä
    ThisWorkbook.Sheets("Main").Range("D18").Value = pankinNimi
    ThisWorkbook.Sheets("Main").Range("B146:C146").Value = pankinNimi
    
    ' Etsitään lainanumeroiden alue
    Dim viimeinenRivi As Long
    On Error Resume Next
    viimeinenRivi = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("LISÄTIEDOT").Row - 1
    On Error GoTo 0
    
    If viimeinenRivi < 1 Then
        MsgBox "Enemmän kuin neljä lainaa löydetty. Tarkista tuodut tiedot lainoista."
        infoTiedosto.Close False
        Exit Sub
    End If
    
    Dim pankkiID As String
    On Error Resume Next
    pankkiID = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("Konttorin numero").Offset(0, 1).Value
    On Error GoTo 0
    
    If pankkiID = "" Then
        MsgBox "Konttorin numero ei löydy. Tarkista tuodut tiedot lainoista."
        infoTiedosto.Close False
        Exit Sub
    End If
    
    Dim lainaNumerotAlue As Range
    Set lainaNumerotAlue = infoTiedosto.Sheets("Yleinen").Range("B1:B" & viimeinenRivi)
    
    Dim lainaNro As Range
    Dim lainaNumerot As Range
    Set lainaNumerot = ThisWorkbook.Sheets("Main").Range("B53:B56")
    
    Dim lainaMaarat As Range
    Set lainaMaarat = ThisWorkbook.Sheets("Main").Range("C53:C56")
    
    Dim laskuri As Integer
    laskuri = 1
    
    For Each lainaNro In lainaNumerotAlue
        If Left(lainaNro.Value, Len(pankkiID)) = pankkiID Then
            lainaNumerot.Cells(laskuri, 1).Value = lainaNro.Value
            lainaMaarat.Cells(laskuri, 1).Value = infoTiedosto.Sheets("Yleinen").Cells(lainaNro.Row, "D").Value
            laskuri = laskuri + 1
            If laskuri > 4 Then
                MsgBox "Enemmän kuin neljä lainaa löydetty. Tarkista tuodut tiedot lainoista."
                infoTiedosto.Close False
                Exit Sub
            End If
        End If
    Next lainaNro
    
    ' Etsitään "Vak_arvon vahvistaja" ja kopioidaan arvo
    Dim vakArvonVahvistaja As Range
    Set vakArvonVahvistaja = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("Vak_arvon vahvistaja", LookAt:=xlWhole)
    
    If Not vakArvonVahvistaja Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A120").Value = vakArvonVahvistaja.Offset(0, 1).Value
    End If
    
    ' Etsitään "Päättäjät" ja kopioidaan arvo
    Dim paattajat As Range
    Set paattajat = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("Päättäjät", LookAt:=xlWhole)
    
    If Not paattajat Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A121").Value = paattajat.Offset(0, 1).Value
    End If
    
    ' Etsitään "Päätös pvm" ja kopioidaan arvo
    Dim paatosPvm As Range
    Set paatosPvm = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("Päätös pvm", LookAt:=xlWhole)
    
    If Not paatosPvm Is Nothing Then
        ThisWorkbook.Sheets("Main").Range("A122").Value = paatosPvm.Offset(0, 1).Value
    End If
    
    ' Suljetaan tietoexcel
    infoTiedosto.Close False
    
    ' Näytetään viesti onnistuneesta tuonnista
    MsgBox "Tiedot tuotu onnistuneesti."
End Sub







UUSITTU:
Sub tietoExcelit()
    On Error GoTo ErrorHandler
    
    Dim infoTiedosto As Workbook
    Dim kansioPolku As String
    Dim panosSolmu As Range
    Dim viimeinenRivi As Long
    Dim pankkiID As String
    Dim loanNumbers As Range
    Dim loanAmounts As Range
    Dim people As Range
    Dim concatenatedPeople As String
    Dim startRow As Long
    Dim rowNum As Long
    Dim uniquePeople As Collection
    
    ' Set the file path
    kansioPolku = Sheets("Tiedot").Range("B40").Value
    
    ' Check if the file exists
    If Dir(kansioPolku) = "" Then
        MsgBox "Tiedostoa ei löytynyt!", vbCritical, "Virhe"
        Exit Sub
    End If
    
    ' Open the info excel file
    Set infoTiedosto = Workbooks.Open(kansioPolku)
    
    ' Find the last row of loan numbers
    viimeinenRivi = infoTiedosto.Sheets("Yleinen").Cells(Rows.Count, 1).End(xlUp).Row
    
    ' Check if "LISÄTIEDOT-rivi" exists
    If viimeinenRivi < 1 Then
        MsgBox "Lainarivejä ei löytynyt!", vbCritical, "Virhe"
        infoTiedosto.Close SaveChanges:=False
        Exit Sub
    End If
    
    ' Find the bank ID
    Set panosSolmu = infoTiedosto.Sheets("Yleinen").Range("A:A").Find("Konttorin numero")
    If panosSolmu Is Nothing Or panosSolmu.Offset(0, 1).Value = "" Then
        MsgBox "Pankki ID:tä ei löytynyt!", vbCritical, "Virhe"
        infoTiedosto.Close SaveChanges:=False
        Exit Sub
    End If
    pankkiID = panosSolmu.Offset(0, 1).Value
    
    ' Find loan numbers, loan amounts, and people involved
    startRow = 2
    rowNum = 53
    Set uniquePeople = New Collection
    
    With infoTiedosto.Sheets("Yleinen")
        Do While startRow <= viimeinenRivi
            If .Cells(startRow, 3).Value Like "Asuntolaina*" Or _
               .Cells(startRow, 3).Value Like "Laina*" Or _
               .Cells(startRow, 3).Value Like "Väliaikaislaina*" Then
               
                ' Loan number
                If loanNumbers Is Nothing Then
                    Set loanNumbers = .Cells(startRow, 1)
                Else
                    Set loanNumbers = Union(loanNumbers, .Cells(startRow, 1))
                End If
                
                ' Loan amount
                If loanAmounts Is Nothing Then
                    Set loanAmounts = .Cells(startRow, 2)
                Else
                    Set loanAmounts = Union(loanAmounts, .Cells(startRow, 2))
                End If
                
                ' People involved
                concatenatedPeople = ""
                Do While .Cells(startRow, 4).Value <> ""
                    concatenatedPeople = concatenatedPeople & .Cells(startRow, 4).Value & ", "
                    uniquePeople.Add .Cells(startRow, 4).Value
                    startRow = startRow + 1
                Loop
                
                ' Remove the extra comma and space at the end
                concatenatedPeople = Left(concatenatedPeople, Len(concatenatedPeople) - 2)
                
                ' Store the concatenated people in the "D" column
                If people Is Nothing Then
                    Set people = .Cells(startRow - 1, 4)
                Else
                    Set people = Union(people, .Cells(startRow - 1, 4))
                End If
                
                ' Write the loan number, loan amount, and concatenated people to the respective cells
                Sheets("Tiedot").Range("B" & rowNum).Value = .Cells(startRow - 1, 1).Value
                Sheets("Tiedot").Range("C" & rowNum).Value = .Cells(startRow - 1, 2).Value
                Sheets("Tiedot").Range("D" & rowNum).Value = concatenatedPeople
                rowNum = rowNum + 1
            Else
                startRow = startRow + 1
            End If
        Loop
    End With
    
    ' Write unique person names and IDs to respective cells
    If uniquePeople.Count > 0 Then
        Sheets("Tiedot").Range("B44").Value = uniquePeople.Item(1) & " 1"
        Sheets("Tiedot").Range("B45").Value = uniquePeople.Item(1) & " 1 " & pankkiID
        
        If uniquePeople.Count > 1 Then
            Sheets("Tiedot").Range("B47").Value = uniquePeople.Item(2) & " 2"
            Sheets("Tiedot").Range("B48").Value = uniquePeople.Item(2) & " 2 " & pankkiID
            
            If uniquePeople.Count > 2 Then
                Sheets("Tiedot").Range("B50").Value = uniquePeople.Item(3) & " 3"
                Sheets("Tiedot").Range("B51").Value = uniquePeople.Item(3) & " 3 " & pankkiID
            End If
        End If
    End If
    
    infoTiedosto.Close SaveChanges:=False
    Exit Sub
    
ErrorHandler:
    MsgBox "Tapahtui virhe: " & Err.Description, vbCritical, "Virhe"
    If Not infoTiedosto Is Nothing Then infoTiedosto.Close SaveChanges:=False
End Sub




