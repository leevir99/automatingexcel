Sub luoMMLkululaskuri()
    ' Define the SharePoint URL and folder address
    Dim sharePointURL As String
    Dim folderAddress As String
    Dim newFileName As String
    
    sharePointURL = "https://oppalveluto365.sharepoint.com/sites/srv00076/Jaetut%20asiakirjat/MML-kululaskuri.xlsm"
    folderAddress = Range("E28").Value
    
    ' Check if the folder address is provided
    If folderAddress = "" Then
        MsgBox "Folder address is missing. Please enter the folder address in cell E28.", vbCritical
        Exit Sub
    End If
    
    ' Check if cell B40 is empty
    If IsEmpty(Range("B40").Value) Then
        MsgBox "Cell B40 is empty. Please enter a value in cell B40.", vbCritical
        Exit Sub
    End If
    
    ' Get the desired filename based on cell B40
    newFileName = "MML-kululaskuri - " & Range("B40").Value & ".xlsm"
    
    ' Check if a file with the same name already exists in the folder
    Dim filePath As String
    filePath = folderAddress & "\" & newFileName
    
    ' Create a new Excel application instance
    Dim xlApp As Object
    Set xlApp = CreateObject("Excel.Application")
    
    ' Disable alerts and screen updating for better performance
    xlApp.DisplayAlerts = False
    xlApp.ScreenUpdating = False
    
    ' Open the source file from SharePoint
    Dim sourceWorkbook As Object
    Set sourceWorkbook = xlApp.Workbooks.Open(sharePointURL)
    
    ' Save the copy to the specified folder
    sourceWorkbook.SaveCopyAs filePath
    
    ' Close the source workbook
    sourceWorkbook.Close False
    
    ' Quit the Excel application
    xlApp.Quit
    
    ' Release the object references
    Set sourceWorkbook = Nothing
    Set xlApp = Nothing
    
    ' Enable alerts and screen updating
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    
    MsgBox "File has been copied successfully!", vbInformation
    
    ' Open the newly created file
    Dim newWorkbook As Workbook
    Set newWorkbook = Workbooks.Open(filePath)
    
    ' Ask the user if they want to import values from "Hankkeet makroilla2.xls"
    Dim response As VbMsgBoxResult
    response = MsgBox("Do you want to import values from 'Hankkeet makroilla2.xls'?", vbQuestion + vbYesNo)
    
    If response = vbYes Then
        ' Import values from "Hankkeet makroilla2.xls" into the new file
        If InStr(1, Workbooks("Hankkeet makroilla2.xls").Sheets(1).Range("A5").Value, "SA") > 0 Then
            ' Import values from B128:B131 in "Hankkeet makroilla2.xls" to G24:G27 in the new file
            newWorkbook.Sheets(1).Range("G24:G27").Value = Workbooks("Hankkeet makroilla2.xls").Sheets(1).Range("B128:B131").Value
            
            ' Execute Sub viepasoytiedot() in the new file
            Application.Run "'" & filePath & "'!viepasoytiedot"
            
            MsgBox "Values have been imported into the newly created file.", vbInformation
        End If
    End If
    
    ' Do not save and close the new workbook
    newWorkbook.Close False
    
    ' Release the object reference
    Set newWorkbook = Nothing
End Sub
